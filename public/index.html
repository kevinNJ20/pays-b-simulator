<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèîÔ∏è Pays B (Hinterland) - Kit Interconnexion UEMOA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* Styles pour les banni√®res et statuts */
        .kit-status-banner {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .kit-status-banner.connected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .kit-status-banner.disconnected {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .kit-status-banner.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.checking {
            background: #ffc107;
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* Styles pour les boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-diagnostic {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn-guce {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            font-size: 16px;
            padding: 15px 30px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Styles pour le workflow */
        .workflow-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .workflow-step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #f093fb;
            position: relative;
            transition: all 0.3s;
        }

        .workflow-step.waiting {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .workflow-step.active {
            background: #fff3cd;
            border-left-color: #ffc107;
            transform: scale(1.05);
        }

        .workflow-step.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .workflow-step.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: #f093fb;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }

        .step-number.waiting {
            background: #6c757d;
        }

        .step-number.active {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        .step-number.completed {
            background: #28a745;
        }

        .step-number.error {
            background: #dc3545;
        }

        .step-content h4 {
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .step-content p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .step-status {
            font-size: 0.8em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }

        .step-status.waiting {
            background: #e9ecef;
            color: #6c757d;
        }

        .step-status.active {
            background: #fff3cd;
            color: #856404;
        }

        .step-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .step-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Styles pour le formulaire de d√©claration */
        .declaration-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #f093fb;
            outline: none;
            box-shadow: 0 0 0 2px rgba(240, 147, 251, 0.25);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .articles-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .btn-remove-article {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-add-article {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        /* Styles pour les listes de donn√©es */
        .data-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #f093fb;
        }

        .data-item.from-kit {
            border-left-color: #667eea;
        }

        .data-item.automated {
            border-left-color: #28a745;
        }

        .data-item.error {
            border-left-color: #dc3545;
        }

        .item-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .item-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            display: inline-block;
        }

        .item-status.success {
            background: #d4edda;
            color: #155724;
        }

        .item-status.processing {
            background: #fff3cd;
            color: #856404;
        }

        .item-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Styles pour le log */
        .kit-log {
            max-height: 350px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #f093fb;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 3px solid #f093fb;
        }

        .log-entry.success {
            border-left-color: #28a745;
        }

        .log-entry.error {
            border-left-color: #dc3545;
        }

        .log-entry.workflow {
            border-left-color: #ffc107;
        }

        .log-entry.kit {
            border-left-color: #667eea;
        }

        /* Styles pour les notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #007bff, #6610f2);
        }

        /* Utilitaires */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-left: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Styles pour la modal de recouvrement */
        .recouvrement-container {
            margin-top: 20px;
        }

        .recouvrement-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f093fb;
        }

        .recouvrement-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .info-item span {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .taxes-container {
            margin-bottom: 20px;
        }

        .taxes-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .taxes-table {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .taxes-header {
            display: grid;
            grid-template-columns: 80px 1fr 150px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: bold;
            padding: 15px;
        }

        .tax-row {
            display: grid;
            grid-template-columns: 80px 1fr 150px;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .tax-row:hover {
            background-color: #f8f9fa;
        }

        .tax-row:last-child {
            border-bottom: none;
        }

        .tax-code {
            font-weight: bold;
            color: #f093fb;
            text-align: center;
        }

        .tax-libelle {
            color: #2c3e50;
        }

        .tax-montant {
            font-weight: bold;
            color: #28a745;
            text-align: right;
        }

        .recouvrement-total {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .total-label {
            font-weight: 600;
            font-size: 1.1em;
        }

        .total-amount {
            font-weight: bold;
            font-size: 1.4em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .recouvrement-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .recouvrement-actions .btn {
            flex: 1;
            min-width: 160px;
            max-width: 200px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 768px) {
            .workflow-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèîÔ∏è Syst√®me Douanier Pays B (Hinterland)</h1>
            <p>üáßüá´ Burkina Faso - Traitement Automatique + Kit MuleSoft</p>
        </header>

        <!-- Banni√®re statut Kit -->
        <div class="kit-status-banner checking" id="kit-banner">
            <div class="loading"></div> V√©rification connexion Kit d'Interconnexion...
        </div>

        <!-- Grille de statut -->
        <div class="status-grid">
            <div class="status-card">
                <h3>üèõÔ∏è Service Local</h3>
                <div class="connection-status">
                    <div class="status-indicator connected"></div>
                    <span>Douanes BFA Actives</span>
                </div>
                <small>Burkina Faso - Traitement automatique</small>
            </div>
            
            <div class="status-card">
                <h3>üîó Kit d'Interconnexion</h3>
                <div class="connection-status">
                    <div class="status-indicator checking" id="kit-indicator"></div>
                    <span id="kit-status-text">V√©rification...</span>
                </div>
                <small id="kit-details">Test de connectivit√© en cours</small>
            </div>
            
            <div class="status-card">
                <h3>üìä Activit√© Automatique</h3>
                <div>Manifestes re√ßus: <strong id="stat-manifestes">0</strong></div>
                <div>Workflows actifs: <strong id="stat-workflows">0</strong></div>
                <div>Paiements envoy√©s: <strong id="stat-paiements">0</strong></div>
            </div>
            
            <div class="status-card">
                <h3>ü§ñ Performance Workflow</h3>
                <div>Taux automatisation: <strong id="taux-automatisation">100%</strong></div>
                <div>Temps moyen: <strong id="temps-moyen">-- s</strong></div>
            </div>
        </div>

        <!-- Section Portail GUCE -->
        <section class="card full-width">
            <h2>üåê Acc√®s aux Services Douaniers</h2>
            <p>Acc√©dez aux diff√©rents portails et services pour la gestion douani√®re compl√®te.</p>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-guce" onclick="ouvrirPortailGUCE()">
                    üåê Acc√©der au Portail GUCE / Pr√©-d√©douanement
                </button>
                <button class="btn btn-primary" onclick="ouvrirModalDeclaration()">
                    üìã Nouvelle D√©claration Douani√®re
                </button>
            </div>
        </section>

        <main class="main">
            <!-- Workflow automatique en temps r√©el -->
            <section class="card full-width">
                <h2>ü§ñ Workflow Automatique en Temps R√©el <span class="real-time-indicator"></span></h2>
                <p>Le syst√®me traite automatiquement les manifestes re√ßus du Kit d'Interconnexion :</p>
                
                <div class="workflow-container">
                    <div class="workflow-step waiting" id="step-1">
                        <div class="step-number waiting">1</div>
                        <div class="step-content">
                            <h4>üì® R√©ception</h4>
                            <p>Manifeste depuis Kit</p>
                            <div class="step-status waiting" id="step-1-status">En attente...</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step waiting" id="step-2">
                        <div class="step-number waiting">2</div>
                        <div class="step-content">
                            <h4>üìù D√©claration</h4>
                            <p>Cr√©ation auto (2s)</p>
                            <div class="step-status waiting" id="step-2-status">En attente...</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step waiting" id="step-3">
                        <div class="step-number waiting">3</div>
                        <div class="step-content">
                            <h4>üí∞ Liquidation</h4>
                            <p>Calcul droits (3s)</p>
                            <div class="step-status waiting" id="step-3-status">En attente...</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step waiting" id="step-4">
                        <div class="step-number waiting">4</div>
                        <div class="step-content">
                            <h4>üí≥ Paiement</h4>
                            <p>Acquittement (5s)</p>
                            <div class="step-status waiting" id="step-4-status">En attente...</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step waiting" id="step-5">
                        <div class="step-number waiting">5</div>
                        <div class="step-content">
                            <h4>üì§ Notification Kit</h4>
                            <p>Vers Kit MuleSoft</p>
                            <div class="step-status waiting" id="step-5-status">En attente...</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-test" onclick="simulerWorkflowComplet()" id="btn-simuler">
                        üß™ Simuler Workflow Complet
                    </button>
                    <button class="btn btn-diagnostic" onclick="testerConnexionKit()">
                        üîß Tester Kit
                    </button>
                </div>
            </section>

            <!-- Manifestes re√ßus -->
            <section class="card">
                <h2>üì® Manifestes Re√ßus du Kit</h2>
                <div class="data-list" id="manifestes-list">
                    <p>En attente de manifestes du Kit...</p>
                </div>
            </section>

            <!-- Paiements automatiques -->
            <section class="card">
                <h2>üí≥ Paiements Automatiques</h2>
                <div class="data-list" id="paiements-list">
                    <p>Aucun paiement...</p>
                </div>
            </section>

            <!-- D√©clarations soumises -->
            <section class="card">
                <h2>üìã D√©clarations Soumises</h2>
                <div class="data-list" id="declarations-list">
                    <p>Aucune d√©claration soumise...</p>
                </div>
            </section>

            <!-- Log des interactions Kit -->
            <section class="card full-width">
                <h2>üîó Journal des Interactions Kit <span class="real-time-indicator"></span></h2>
                <div class="kit-log" id="kit-log">
                    <div class="log-entry workflow">
                        <strong>Syst√®me initialis√©</strong> - Monitoring des √©changes avec Kit d'Interconnexion activ√©
                        <span style="float: right; color: #6c757d; font-size: 0.8em;" id="init-time"></span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal pour la d√©claration -->
    <div id="declarationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fermerModalDeclaration()">&times;</span>
            <h2>üìã Nouvelle D√©claration Douani√®re</h2>
            <p>Saisissez les informations de la d√©claration douani√®re pour envoi via Kit MuleSoft.</p>
            
            <form id="declarationForm" class="declaration-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="anneeDecl">Ann√©e D√©claration</label>
                        <input type="text" id="anneeDecl" class="form-control" value="2025" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="bureauDecl">Bureau D√©claration</label>
                        <input type="text" id="bureauDecl" class="form-control" value="10S" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="numeroDecl">Num√©ro D√©claration</label>
                        <input type="number" id="numeroDecl" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="dateDecl">Date D√©claration</label>
                        <input type="date" id="dateDecl" class="form-control" required>
                    </div>
                </div>

                <h3>Articles</h3>
                <div id="articles-container">
                    <!-- Les articles seront ajout√©s dynamiquement -->
                </div>
                <button type="button" class="btn-add-article" onclick="ajouterArticle()">+ Ajouter Article</button>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">üì§ Soumettre D√©claration</button>
                    <button type="button" class="btn btn-diagnostic" onclick="fermerModalDeclaration()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour le recouvrement -->
    <div id="recouvrementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fermerModalRecouvrement()">&times;</span>
            <h2>üí∞ Donn√©es de Recouvrement</h2>
            <p>D√©tail des taxes et redevances calcul√©es pour cette d√©claration douani√®re.</p>
            
            <div class="recouvrement-container">
                <!-- Informations principales -->
                <div class="recouvrement-header">
                    <div class="recouvrement-info">
                        <h3>üìã Informations D√©claration</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Num√©ro D√©claration:</label>
                                <span id="recouvr-numero"></span>
                            </div>
                            <div class="info-item">
                                <label>Ann√©e:</label>
                                <span id="recouvr-annee"></span>
                            </div>
                            <div class="info-item">
                                <label>Bureau:</label>
                                <span id="recouvr-bureau"></span>
                            </div>
                            <div class="info-item">
                                <label>Date R√®glement:</label>
                                <span id="recouvr-date"></span>
                            </div>
                            <div class="info-item">
                                <label>Mode R√®glement:</label>
                                <span id="recouvr-mode"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- D√©tail des taxes -->
                <div class="taxes-container">
                    <h3>üìä D√©tail des Taxes et Redevances</h3>
                    <div class="taxes-table">
                        <div class="taxes-header">
                            <div class="tax-code">Code</div>
                            <div class="tax-libelle">Libell√©</div>
                            <div class="tax-montant">Montant (FCFA)</div>
                        </div>
                        <div id="taxes-list">
                            <!-- Les taxes seront ajout√©es dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Total -->
                <div class="recouvrement-total">
                    <div class="total-line">
                        <span class="total-label">MONTANT TOTAL √Ä RECOUVRER:</span>
                        <span class="total-amount" id="recouvr-total">0 FCFA</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="recouvrement-actions">
                    <button class="btn btn-primary" onclick="procederPaiement()">
                        üí≥ Proc√©der au Paiement
                    </button>
                    <button class="btn btn-diagnostic" onclick="imprimerRecouvrement()">
                        üñ®Ô∏è Imprimer Bordereau
                    </button>
                    <button class="btn btn-secondary" onclick="fermerModalRecouvrement()">
                        üìÑ Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api';
        const KIT_URL = 'http://localhost:8080';
        
        let statusInterval;
        let refreshInterval;
        let kitConnected = false;
        let workflowActive = false;
        let articleCount = 0;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation Pays B - Workflow Automatique + Kit MuleSoft');
            
            document.getElementById('init-time').textContent = new Date().toLocaleTimeString();
            
            // Initialiser le formulaire avec un article par d√©faut
            ajouterArticle();
            
            // V√©rifications p√©riodiques
            verifierStatutKit();
            statusInterval = setInterval(verifierStatutKit, 15000);
            
            // Actualisation donn√©es
            chargerDonnees();
            refreshInterval = setInterval(chargerDonnees, 8000);
            
            ajouterLogEntry('workflow', 'Service d√©marr√©', 'Pays B op√©rationnel - Workflow automatique activ√©');
        });

        // Ouvrir le portail GUCE dans une nouvelle fen√™tre
        function ouvrirPortailGUCE() {
            // URL simul√©e du portail GUCE - remplacer par la vraie URL
            const urlGUCE = 'https://guce.gov.bf/portal'; // URL exemple
            
            // Ouvrir dans une nouvelle fen√™tre
            const nouvelleFenetre = window.open(
                urlGUCE, 
                'PortailGUCE',
                'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=yes,menubar=yes'
            );
            
            if (nouvelleFenetre) {
                ajouterLogEntry('guce', 'Portail GUCE', 'Ouverture du portail GUCE/Pr√©-d√©douanement');
                afficherNotification('üåê Portail GUCE ouvert dans une nouvelle fen√™tre', 'info');
            } else {
                afficherNotification('‚ùå Impossible d\'ouvrir le portail GUCE. V√©rifiez les pop-ups.', 'error');
            }
        }

        // Ouvrir la modal de d√©claration
        function ouvrirModalDeclaration() {
            document.getElementById('declarationModal').style.display = 'block';
            document.getElementById('numeroDecl').value = Date.now().toString().slice(-6);
            document.getElementById('dateDecl').value = new Date().toISOString().split('T')[0];
        }

        // Fermer la modal de d√©claration
        function fermerModalDeclaration() {
            document.getElementById('declarationModal').style.display = 'none';
        }

        // Fermer la modal de recouvrement
        function fermerModalRecouvrement() {
            document.getElementById('recouvrementModal').style.display = 'none';
        }

        // Afficher la modal de recouvrement avec les donn√©es
        function afficherModalRecouvrement(donneesDeclaration, donneesRecouvrement) {
            // Remplir les informations principales
            document.getElementById('recouvr-numero').textContent = donneesDeclaration.numeroDecl;
            document.getElementById('recouvr-annee').textContent = donneesDeclaration.anneeDecl;
            document.getElementById('recouvr-bureau').textContent = donneesDeclaration.bureauDecl;
            document.getElementById('recouvr-date').textContent = donneesRecouvrement.dateReglement;
            document.getElementById('recouvr-mode').textContent = donneesRecouvrement.modeReglement.toUpperCase();

            // Remplir le tableau des taxes
            const taxesList = document.getElementById('taxes-list');
            taxesList.innerHTML = '';
            
            donneesRecouvrement.taxes.forEach(taxe => {
                const taxRow = document.createElement('div');
                taxRow.className = 'tax-row';
                taxRow.innerHTML = `
                    <div class="tax-code">${taxe.codeTaxe}</div>
                    <div class="tax-libelle">${taxe.libelleTaxe}</div>
                    <div class="tax-montant">${taxe.montantTaxe.toLocaleString()} FCFA</div>
                `;
                taxesList.appendChild(taxRow);
            });

            // Afficher le montant total
            document.getElementById('recouvr-total').textContent = 
                donneesRecouvrement.montantTotal.toLocaleString() + ' FCFA';

            // Afficher la modal
            document.getElementById('recouvrementModal').style.display = 'block';
        }

        // Simuler les donn√©es de recouvrement bas√©es sur la d√©claration
        function simulerDonneesRecouvrement(declaration) {
            // Calculer une valeur totale bas√©e sur les articles
            const valeurTotaleArticles = declaration.articles.reduce((total, article) => {
                return total + parseInt(article.valeurCaf);
            }, 0);

            // Calculer les taxes de mani√®re r√©aliste
            const droitDouane = Math.round(valeurTotaleArticles * 0.15); // 15%
            const redevanceStatistique = Math.round(valeurTotaleArticles * 0.01); // 1%
            const prelevementSolidarite = Math.round(valeurTotaleArticles * 0.12); // 12%
            const prelevementCEDEAO = Math.round(valeurTotaleArticles * 0.08); // 8%

            const taxes = [
                {
                    codeTaxe: "01",
                    libelleTaxe: "Droit de Douane",
                    montantTaxe: droitDouane
                },
                {
                    codeTaxe: "03",
                    libelleTaxe: "Redevance Statistique",
                    montantTaxe: redevanceStatistique
                },
                {
                    codeTaxe: "30",
                    libelleTaxe: "Pr√©l√®vement Communautaire de Solidarit√©",
                    montantTaxe: prelevementSolidarite
                },
                {
                    codeTaxe: "31",
                    libelleTaxe: "Pr√©l√®vement Communautaire CEDEAO",
                    montantTaxe: prelevementCEDEAO
                }
            ];

            const montantTotal = taxes.reduce((total, taxe) => total + taxe.montantTaxe, 0);

            return {
                anneeDecl: declaration.anneeDecl,
                bureauDecl: declaration.bureauDecl,
                numeroDecl: declaration.numeroDecl,
                dateReglement: new Date().toISOString().split('T')[0],
                modeReglement: "comptant",
                montantTotal: montantTotal,
                taxes: taxes
            };
        }

        // Fonction helper pour charger les d√©clarations
        async function chargerDeclarationsData() {
            try {
                const response = await fetch(`${API_BASE}/declaration/lister?limite=50`);
                const data = await response.json();
                
                if (data.status === 'SUCCESS' && data.declarations) {
                    return data.declarations;
                }
                return [];
            } catch (error) {
                console.error('Erreur chargement d√©clarations:', error);
                return [];
            }
        }

        // Fonction pour recevoir la notification d'apurement r√©ussi
        window.notifierApurementReussi = function(resultat) {
            console.log('Notification apurement re√ßu de Pays A:', resultat);
            
            if (resultat && resultat.status === 'SUCCESS') {
                // Envoyer un message via postMessage aussi
                window.postMessage({
                    type: 'APUREMENT_COMPLETE',
                    numeroManifeste: resultat.apurement.numeroManifeste,
                    referencePaiement: resultat.apurement.referencePaiement
                }, '*');
            }
        };

        // Fonction pour enregistrer le paiement via l'API
        async function enregistrerPaiement(donneesPaiement) {
            try {
                const response = await fetch(`${API_BASE}/paiement/effectuer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'PAYS_B_DOUANES',
                        'X-Source-Country': 'BFA'
                    },
                    body: JSON.stringify(donneesPaiement)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erreur lors de l\'enregistrement du paiement');
                }
                
                const result = await response.json();
                console.log('Paiement enregistr√©:', result);
                return result;
                
            } catch (error) {
                console.error('Erreur enregistrement paiement:', error);
                throw error;
            }
        }

        // G√©rer les messages depuis Pays A
        function handleMessageFromPaysA(event) {
            // V√©rifier l'origine pour la s√©curit√©
            if (event.origin !== 'http://localhost:3001') return;
            
            const data = event.data;
            if (data.type === 'APUREMENT_COMPLETE') {
                ajouterLogEntry('apurement', 'Apurement confirm√©', `Manifeste ${data.numeroManifeste} apur√© avec succ√®s`);
                afficherNotification('‚úÖ Apurement confirm√© - Les marchandises peuvent √™tre lev√©es', 'success');
                
                // Actualiser les donn√©es
                chargerDonnees();
                
                // Retirer l'√©couteur
                window.removeEventListener('message', handleMessageFromPaysA);
            }
        }

        // Nouvelle fonction pour ouvrir l'interface d'apurement dans Pays A
        function ouvrirApurementPaysA(numeroManifeste, referencePaiement) {
            // URL de Pays A avec les param√®tres d'apurement
            const urlPaysA = `http://localhost:3001/?apurement_manifeste=${encodeURIComponent(numeroManifeste)}&apurement_paiement=${encodeURIComponent(referencePaiement)}`;
            
            ajouterLogEntry('apurement', 'Ouverture Pays A', `Transfert vers syst√®me d'origine pour apurement`);
            afficherNotification('üîì Ouverture de l\'interface d\'apurement...', 'info');
            
            // Ouvrir dans une nouvelle fen√™tre
            const fenetreApurement = window.open(
                urlPaysA,
                'ApurementPaysA',
                'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,menubar=no'
            );
            
            if (fenetreApurement) {
                // Stocker la r√©f√©rence de la fen√™tre pour communication future
                window.fenetreApurement = fenetreApurement;
                
                // √âcouter les messages de Pays A
                window.addEventListener('message', handleMessageFromPaysA);
                
                ajouterLogEntry('apurement', 'Fen√™tre ouverte', 'Interface d\'apurement Pays A active');
            } else {
                afficherNotification('‚ùå Impossible d\'ouvrir l\'interface d\'apurement. V√©rifiez les pop-ups.', 'error');
            }
        }

        // Proc√©der au paiement et ouvrir l'apurement dans Pays A
        async function procederPaiement() {
            const numeroDecl = document.getElementById('recouvr-numero').textContent;
            const montantTotal = parseInt(document.getElementById('recouvr-total').textContent.replace(/[^\d]/g, ''));
            
            // Stocker les informations pour l'apurement
            window.dernierPaiement = {
                numeroDeclaration: numeroDecl,
                montant: montantTotal,
                date: new Date().toISOString()
            };
            
            afficherNotification('üí≥ Traitement du paiement...', 'info');
            ajouterLogEntry('paiement', 'Paiement initi√©', 'Proc√©dure de paiement d√©marr√©e');
            
            // Simuler le traitement du paiement
            setTimeout(async () => {
                try {
                    // G√©n√©rer une r√©f√©rence de paiement
                    const referencePaiement = `PAY_${Date.now()}`;
                    
                    // R√©cup√©rer le num√©ro de manifeste depuis la d√©claration
                    const declarations = await chargerDeclarationsData();
                    const declaration = declarations.find(d => d.numeroDeclaration === numeroDecl);
                    
                    if (!declaration || !declaration.manifesteOrigine) {
                        throw new Error('Impossible de trouver le manifeste associ√© √† cette d√©claration');
                    }
                    
                    // Enregistrer le paiement localement
                    await enregistrerPaiement({
                        numeroDeclaration: numeroDecl,
                        manifesteOrigine: declaration.manifesteOrigine,
                        numeroManifesteOrigine: declaration.numeroManifesteOrigine,
                        montantPaye: montantTotal,
                        referencePaiement: referencePaiement,
                        modePaiement: 'ELECTRONIQUE'
                    });
                    
                    afficherNotification('‚úÖ Paiement enregistr√© avec succ√®s', 'success');
                    ajouterLogEntry('paiement', 'Paiement confirm√©', `R√©f√©rence: ${referencePaiement}`);
                    
                    // Fermer la modal de recouvrement
                    fermerModalRecouvrement();
                    
                    // Ouvrir l'interface d'apurement dans Pays A
                    setTimeout(() => {
                        ouvrirApurementPaysA(declaration.numeroManifesteOrigine, referencePaiement);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Erreur lors du paiement:', error);
                    afficherNotification('‚ùå Erreur: ' + error.message, 'error');
                }
            }, 2000);
        }


        // Imprimer le bordereau de recouvrement
        function imprimerRecouvrement() {
            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            const numeroDecl = document.getElementById('recouvr-numero').textContent;
            const anneeDecl = document.getElementById('recouvr-annee').textContent;
            const bureauDecl = document.getElementById('recouvr-bureau').textContent;
            const dateReglement = document.getElementById('recouvr-date').textContent;
            const modeReglement = document.getElementById('recouvr-mode').textContent;
            const montantTotal = document.getElementById('recouvr-total').textContent;
            
            // R√©cup√©rer les taxes
            const taxes = [];
            document.querySelectorAll('#taxes-list .tax-row').forEach(row => {
                const code = row.querySelector('.tax-code').textContent;
                const libelle = row.querySelector('.tax-libelle').textContent;
                const montant = row.querySelector('.tax-montant').textContent;
                taxes.push({ code, libelle, montant });
            });

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bordereau de Recouvrement - ${numeroDecl}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .info-section { margin-bottom: 20px; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
                        .info-item { padding: 5px 0; }
                        .info-label { font-weight: bold; }
                        .taxes-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .taxes-table th, .taxes-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .taxes-table th { background-color: #f2f2f2; }
                        .total-section { margin-top: 30px; padding: 15px; background-color: #f8f9fa; border: 2px solid #28a745; text-align: center; }
                        .total-amount { font-size: 1.5em; font-weight: bold; color: #28a745; }
                        .footer { margin-top: 40px; text-align: center; font-size: 0.9em; color: #666; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üèîÔ∏è BURKINA FASO</h1>
                        <h2>DIRECTION G√âN√âRALE DES DOUANES</h2>
                        <h3>BORDEREAU DE RECOUVREMENT</h3>
                    </div>
                    
                    <div class="info-section">
                        <h3>Informations de la D√©claration</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Num√©ro de D√©claration:</span> ${numeroDecl}
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ann√©e:</span> ${anneeDecl}
                            </div>
                            <div class="info-item">
                                <span class="info-label">Bureau:</span> ${bureauDecl}
                            </div>
                            <div class="info-item">
                                <span class="info-label">Date de R√®glement:</span> ${dateReglement}
                            </div>
                            <div class="info-item">
                                <span class="info-label">Mode de R√®glement:</span> ${modeReglement}
                            </div>
                            <div class="info-item">
                                <span class="info-label">Date d'√©dition:</span> ${new Date().toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="taxes-section">
                        <h3>D√©tail des Taxes et Redevances</h3>
                        <table class="taxes-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Libell√© de la Taxe</th>
                                    <th>Montant (FCFA)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${taxes.map(taxe => `
                                    <tr>
                                        <td>${taxe.code}</td>
                                        <td>${taxe.libelle}</td>
                                        <td style="text-align: right;">${taxe.montant}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="total-section">
                        <h3>MONTANT TOTAL √Ä RECOUVRER</h3>
                        <div class="total-amount">${montantTotal}</div>
                    </div>
                    
                    <div class="footer">
                        <p>Document g√©n√©r√© automatiquement par le Syst√®me Douanier du Burkina Faso</p>
                        <p>Kit d'Interconnexion UEMOA - ${new Date().toLocaleString('fr-FR')}</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Imprimer</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Fermer</button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            ajouterLogEntry('impression', 'Bordereau imprim√©', `Bordereau de recouvrement g√©n√©r√© pour d√©claration ${numeroDecl}`);
            afficherNotification('üñ®Ô∏è Bordereau de recouvrement g√©n√©r√©', 'success');
        }

        // Ajouter un article au formulaire
        function ajouterArticle() {
            articleCount++;
            const container = document.getElementById('articles-container');
            
            const articleDiv = document.createElement('div');
            articleDiv.className = 'articles-container';
            articleDiv.id = `article-${articleCount}`;
            
            articleDiv.innerHTML = `
                <div class="article-header">
                    <h4>Article ${articleCount}</h4>
                    ${articleCount > 1 ? `<button type="button" class="btn-remove-article" onclick="supprimerArticle(${articleCount})">Supprimer</button>` : ''}
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Num√©ro Article</label>
                        <input type="number" name="numArt_${articleCount}" class="form-control" value="${articleCount}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Connaissement</label>
                        <input type="text" name="connaissement_${articleCount}" class="form-control" value="NAM${Date.now().toString().slice(-7)}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mode Conditionnement</label>
                        <select name="modeCond_${articleCount}" class="form-control" required>
                            <option value="ROULEAU">ROULEAU</option>
                            <option value="COLIS">COLIS</option>
                            <option value="CONTENEUR">CONTENEUR</option>
                            <option value="PALETTE">PALETTE</option>
                            <option value="CARTON">CARTON</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Code SH</label>
                        <input type="text" name="codeSh_${articleCount}" class="form-control" value="4703210000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Origine</label>
                        <input type="text" name="origine_${articleCount}" class="form-control" value="√âTATS-UNIS" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Libell√© Tarif</label>
                    <input type="text" name="libelleTarif_${articleCount}" class="form-control" value="- Mi-blanchies ou blanchies :-- De coniferes" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">D√©signation Commerciale</label>
                    <textarea name="designationCom_${articleCount}" class="form-control" rows="2" required>CNTR MISSING IN LARA 270 ROLLS (135 PACKS) FLUFF PULP 104.699 ADMT BSC 0789609 DTHC COLLECT ITN X20241001359826 ROLLS</textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre Colis</label>
                        <input type="number" name="nbreColis_${articleCount}" class="form-control" value="270" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Brut (kg)</label>
                        <input type="number" name="poidsBrut_${articleCount}" class="form-control" value="102442" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Net (kg)</label>
                        <input type="number" name="poidsNet_${articleCount}" class="form-control" value="102442" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valeur CAF</label>
                        <input type="number" name="valeurCaf_${articleCount}" class="form-control" value="77948508" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Liquidation</label>
                        <input type="number" name="liquidation_${articleCount}" class="form-control" value="22433580" required>
                    </div>
                </div>
            `;
            
            container.appendChild(articleDiv);
        }

        // Supprimer un article
        function supprimerArticle(articleId) {
            const article = document.getElementById(`article-${articleId}`);
            if (article) {
                article.remove();
            }
        }

        // Soumettre la d√©claration
        document.getElementById('declarationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Collecter les donn√©es du formulaire
                const formData = new FormData(this);
                
                const declaration = {
                    anneeDecl: document.getElementById('anneeDecl').value,
                    bureauDecl: document.getElementById('bureauDecl').value,
                    numeroDecl: parseInt(document.getElementById('numeroDecl').value),
                    dateDecl: document.getElementById('dateDecl').value,
                    articles: []
                };
                
                // Collecter les articles
                const articlesContainers = document.querySelectorAll('.articles-container');
                articlesContainers.forEach(container => {
                    const articleId = container.id.split('-')[1];
                    
                    const article = {
                        numArt: parseInt(formData.get(`numArt_${articleId}`)),
                        connaissement: formData.get(`connaissement_${articleId}`),
                        modeCond: formData.get(`modeCond_${articleId}`),
                        codeSh: formData.get(`codeSh_${articleId}`),
                        libelleTarif: formData.get(`libelleTarif_${articleId}`),
                        designationCom: formData.get(`designationCom_${articleId}`),
                        origine: formData.get(`origine_${articleId}`),
                        nbreColis: parseInt(formData.get(`nbreColis_${articleId}`)),
                        poidsBrut: parseInt(formData.get(`poidsBrut_${articleId}`)),
                        poidsNet: parseInt(formData.get(`poidsNet_${articleId}`)),
                        valeurCaf: parseInt(formData.get(`valeurCaf_${articleId}`)),
                        liquidation: parseInt(formData.get(`liquidation_${articleId}`))
                    };
                    
                    declaration.articles.push(article);
                });
                
                console.log('üìã D√©claration √† soumettre:', declaration);
                
                // Envoyer la d√©claration via l'API
                const response = await fetch(`${API_BASE}/declaration/soumettre`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'PAYS_B_DOUANES',
                        'X-Source-Country': 'BFA'
                    },
                    body: JSON.stringify(declaration)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    afficherNotification('‚úÖ D√©claration soumise avec succ√®s', 'success');
                    ajouterLogEntry('declaration', 'Nouvelle d√©claration', `D√©claration ${declaration.numeroDecl} soumise vers Kit MuleSoft`);
                    
                    // Fermer la modal de d√©claration
                    fermerModalDeclaration();
                    
                    // Simuler et afficher les donn√©es de recouvrement
                    const donneesRecouvrement = simulerDonneesRecouvrement(declaration);
                    
                    // Afficher la modal de recouvrement apr√®s un court d√©lai
                    setTimeout(() => {
                        afficherModalRecouvrement(declaration, donneesRecouvrement);
                    }, 500);
                    
                    // Actualiser la liste des d√©clarations
                    setTimeout(() => chargerDeclarations(), 1000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erreur lors de la soumission');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur soumission d√©claration:', error);
                afficherNotification('‚ùå Erreur: ' + error.message, 'error');
            }
        });

        // === FONCTIONS EXISTANTES (workflow, etc.) ===
        
        // V√©rification du statut Kit (simplifi√©)
        async function verifierStatutKit() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const banner = document.getElementById('kit-banner');
                const indicator = document.getElementById('kit-indicator');
                const statusText = document.getElementById('kit-status-text');
                const details = document.getElementById('kit-details');
                
                if (data.kit && data.kit.accessible) {
                    banner.className = 'kit-status-banner connected';
                    banner.innerHTML = `‚úÖ Kit d'Interconnexion op√©rationnel - ${data.kit.status}`;
                    
                    indicator.className = 'status-indicator connected';
                    statusText.textContent = 'Kit Op√©rationnel';
                    details.textContent = `Latence: ${data.kit.latence}ms`;
                    
                    kitConnected = true;
                } else {
                    banner.className = 'kit-status-banner disconnected';
                    banner.innerHTML = `‚ùå Kit d'Interconnexion inaccessible - Mode autonome`;
                    
                    indicator.className = 'status-indicator';
                    statusText.textContent = 'Kit Inaccessible';
                    details.textContent = 'Workflow continue en mode autonome';
                    
                    kitConnected = false;
                }
                
            } catch (error) {
                console.error('Erreur v√©rification Kit:', error);
                kitConnected = false;
            }
        }

        // Test de connexion Kit
        async function testerConnexionKit() {
            ajouterLogEntry('kit', 'Test connexion Kit', 'Test de connectivit√© d√©marr√©...');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.kit && data.kit.accessible) {
                    afficherNotification(`‚úÖ Kit accessible - Latence: ${data.kit.latence}ms`, 'success');
                    ajouterLogEntry('kit', 'Test Kit', `‚úÖ Succ√®s - Latence: ${data.kit.latence}ms`);
                } else {
                    throw new Error('Kit inaccessible');
                }
                
            } catch (error) {
                afficherNotification('‚ùå Kit inaccessible: ' + error.message, 'error');
                ajouterLogEntry('kit', 'Test Kit', `‚ùå √âchec: ${error.message}`);
            }
        }

        // Simuler workflow complet (simplifi√©)
        async function simulerWorkflowComplet() {
            if (workflowActive) {
                afficherNotification('‚è≥ Workflow d√©j√† en cours...', 'info');
                return;
            }
            
            workflowActive = true;
            afficherNotification('üöÄ D√©marrage simulation workflow', 'info');
            
            // Simulation simplifi√©e - √† compl√©ter avec la logique existante
            setTimeout(() => {
                afficherNotification('‚úÖ Workflow simul√© termin√©', 'success');
                workflowActive = false;
            }, 3000);
        }

        // Charger toutes les donn√©es
        async function chargerDonnees() {
            await Promise.all([
                chargerStatistiques(),
                chargerManifestes(),
                chargerPaiements(),
                chargerDeclarations()
            ]);
        }

        // Charger statistiques (simplifi√©)
        async function chargerStatistiques() {
            try {
                const response = await fetch(`${API_BASE}/statistiques`);
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    const stats = data.statistiques;
                    
                    document.getElementById('stat-manifestes').textContent = stats.manifestesRecus || 0;
                    document.getElementById('stat-workflows').textContent = data.workflow?.actifs || 0;
                    document.getElementById('stat-paiements').textContent = stats.paiementsEffectues || 0;
                    document.getElementById('taux-automatisation').textContent = (stats.tauxAutomatisation || 100) + '%';
                    document.getElementById('temps-moyen').textContent = 
                        stats.performance?.tempsTraitementMoyen > 0 ? stats.performance.tempsTraitementMoyen + ' s' : '-- s';
                }
                
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        // Charger manifestes (simplifi√©)
        async function chargerManifestes() {
            try {
                const response = await fetch(`${API_BASE}/manifeste/lister?limite=5`);
                const data = await response.json();
                
                const container = document.getElementById('manifestes-list');
                
                if (data.status === 'SUCCESS' && data.manifestes && data.manifestes.length > 0) {
                    container.innerHTML = data.manifestes.map(manifeste => {
                        const statusClass = manifeste.workflow?.statut === 'COMPLETE' ? 'success' : 
                                           manifeste.workflow?.statut === 'EN_COURS' ? 'processing' : '';
                        
                        return `
                            <div class="data-item from-kit">
                                <div class="item-header">
                                    üì® ${manifeste.numeroOrigine} - ${manifeste.transporteur}
                                    <span class="item-status ${statusClass}">
                                        ${manifeste.workflow?.statut || 'RECU'}
                                    </span>
                                </div>
                                <div class="item-details">
                                    üìç Depuis: ${manifeste.origine?.pays || 'Kit'}<br>
                                    üì¶ ${manifeste.marchandises.nombre} marchandise(s)<br>
                                    üîÑ √âtape: ${manifeste.workflow?.etapeActuelle || 'RECEPTION'}<br>
                                    üìÖ ${new Date(manifeste.dateReception).toLocaleString('fr-FR')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p>En attente de manifestes du Kit...</p>';
                }
                
            } catch (error) {
                console.error('Erreur chargement manifestes:', error);
                document.getElementById('manifestes-list').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        // Charger paiements avec √©tat d'apurement
        async function chargerPaiements() {
            try {
                const response = await fetch(`${API_BASE}/paiement/lister?limite=5`);
                const data = await response.json();
                
                const container = document.getElementById('paiements-list');
                
                if (data.status === 'SUCCESS' && data.paiements && data.paiements.length > 0) {
                    container.innerHTML = data.paiements.map(paiement => {
                        // V√©rifier l'√©tat d'apurement
                        const estApure = paiement.apurement && paiement.apurement.statut === 'CONFIRME';
                        const classeApurement = estApure ? 'apure' : 'automated';
                        const statusClass = estApure ? 'apure' : 'success';
                        const statusText = estApure ? 'APUR√â' : 'CONFIRM√â';
                        
                        let html = `
                            <div class="data-item ${classeApurement}">
                                <div class="item-header">
                                    üí≥ ${paiement.id}
                                    <span class="item-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="item-details">
                                    üí∞ Montant: ${paiement.montantPaye.toLocaleString()} FCFA<br>
                                    üè¶ Mode: ${paiement.modePaiement}<br>
                                    üìÖ ${new Date(paiement.datePaiement).toLocaleString('fr-FR')}
                        `;
                        
                        if (estApure) {
                            html += `<br>üîì Apur√© le: ${new Date(paiement.apurement.dateApurement).toLocaleDateString('fr-FR')}`;
                        } else if (paiement.manifesteOrigine && paiement.referencePaiement) {
                            // Ajouter un bouton pour ouvrir l'apurement manuellement si pas encore fait
                            html += `<br><button class="btn btn-apurement" onclick="ouvrirApurementPaysA('${paiement.manifesteOrigine}', '${paiement.referencePaiement}')">
                                üîì Proc√©der √† l'apurement
                            </button>`;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                        
                        return html;
                    }).join('');
                } else {
                    container.innerHTML = '<p>Aucun paiement effectu√©</p>';
                }
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
                document.getElementById('paiements-list').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        // Charger d√©clarations
        async function chargerDeclarations() {
            try {
                const response = await fetch(`${API_BASE}/declaration/lister?limite=5`);
                const data = await response.json();
                
                const container = document.getElementById('declarations-list');
                
                if (data.status === 'SUCCESS' && data.declarations && data.declarations.length > 0) {
                    container.innerHTML = data.declarations.map(declaration => `
                        <div class="data-item">
                            <div class="item-header">
                                üìã ${declaration.numeroDeclaration}
                                <span class="item-status ${declaration.statut.toLowerCase()}">${declaration.statut}</span>
                            </div>
                            <div class="item-details">
                                üìÖ ${declaration.dateDeclaration}<br>
                                üì¶ ${declaration.articles?.length || 0} article(s)<br>
                                üí∞ Valeur: ${declaration.valeurTotale?.toLocaleString() || 'N/A'} FCFA<br>
                                üîÑ Statut: ${declaration.statut}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>Aucune d√©claration soumise</p>';
                }
            } catch (error) {
                console.error('Erreur chargement d√©clarations:', error);
                document.getElementById('declarations-list').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        // Ajouter entr√©e dans le log
        function ajouterLogEntry(type, action, details) {
            const container = document.getElementById('kit-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <strong>${action}</strong> - ${details}
                <span style="float: right; color: #6c757d; font-size: 0.8em;">${timestamp}</span>
            `;
            
            container.prepend(entry);
            
            // Garder seulement les 20 derni√®res entr√©es
            const entries = container.querySelectorAll('.log-entry');
            if (entries.length > 20) {
                entries[entries.length - 1].remove();
            }
        }

        // Afficher notification
        function afficherNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (statusInterval) clearInterval(statusInterval);
            if (refreshInterval) clearInterval(refreshInterval);
        });

        // Fermer la modal si on clique √† l'ext√©rieur
        window.onclick = function(event) {
            const declarationModal = document.getElementById('declarationModal');
            const recouvrementModal = document.getElementById('recouvrementModal');
            
            if (event.target === declarationModal) {
                fermerModalDeclaration();
            }
            
            if (event.target === recouvrementModal) {
                fermerModalRecouvrement();
            }
        }
    </script>
</body>
</html>